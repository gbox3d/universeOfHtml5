import{FaceLandmarker as e,FilesetResolver as t}from"https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@20230920.0.0";export default(async(a,i,r=20)=>{let o,n,s={x:0,y:0},l=null;i&&(n=i.getContext("2d"));let d={x:0,y:0,z:0},c=await t.forVisionTasks("https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@20230920.0.0/wasm");o=await e.createFromOptions(c,{baseOptions:{modelAssetPath:"https://storage.googleapis.com/mediapipe-models/face_landmarker/face_landmarker/float16/1/face_landmarker.task",delegate:"GPU"},outputFacialTransformationMatrixes:!0,runningMode:"VIDEO",numFaces:5});let $=null,m=async()=>{let e=await o.detectForVideo(a,performance.now());$=e;try{if(e.faceLandmarks&&e.faceLandmarks.length>0&&e.facialTransformationMatrixes.length>0){let t=e.facialTransformationMatrixes[0],i=t.data;l=i.map(e=>parseFloat(e.toFixed(3)));let r={x:i[12],y:i[13],z:i[14]},n={x:i[8],y:i[9],z:i[10]};d=f(r,n)}}catch(s){console.error(s)}requestAnimationFrame(m)};function f(e,t){let a=(0-e.z)/t.z;return{x:e.x+a*t.x,y:e.y+a*t.y,z:0}}function g(e){return new Promise((t,a)=>{e.readyState>=2?t():(e.addEventListener("loadeddata",()=>t(),{once:!0}),e.addEventListener("error",()=>a("❌ Video failed to load."),{once:!0}))})}let h=()=>Math.sqrt((s.x-d.x)**2+(s.y-d.y)**2),y=()=>{let e=h();return Math.max(0,100*(1-e/r))},x=()=>{let e=$;if(!e.faceLandmarks||0===e.faceLandmarks.length)return{faceok:!1,eyeclose:!1,mouthclose:!0,oneface:!1};let t=e.faceLandmarks.length>0,a=1===e.faceLandmarks.length;if(!a)return{faceok:t,eyeclose:!1,mouthclose:!0,oneface:a};let i=e.faceLandmarks[0],r=i[159],o=i[145],n=i[386],s=i[374],l=i[13],d=i[14],c=(e,t)=>Math.sqrt((e.x-t.x)**2+(e.y-t.y)**2),m=c(r,o),f=c(n,s),g=(m+f)/2,h=c(l,d),y=g<.015,x=h<.04,_={left:m<.015,right:f<.015};return{faceok:t,eyeclose:y,mouthclose:x,oneface:a,eyeclose2:_}};return{version:"1.0.2",async start(e=!1){try{e&&(a.style.display="none");let t=await navigator.mediaDevices.getUserMedia({video:!0});return a.srcObject=t,await g(a),i&&(i.width=a.videoWidth,i.height=a.videoHeight),console.log("\uD83D\uDCCC Webcam successfully loaded."),m(),{success:!0,videoWidth:a.videoWidth,videoHeight:a.videoHeight}}catch(r){return console.error("❌ Error accessing webcam:",r),{success:!1,error:r}}},updateLookAtOrigin(){s.x=d.x,s.y=d.y},getLookAtOrigin:()=>s,getLookAtPoint:()=>d,getGazeDistance:()=>h(),getFocusPercentage:()=>y(),getFaceStatus:()=>x(),getFaceTransformMatrix:()=>l,drawCanvas(){n.clearRect(0,0,i.width,i.height);let e=i.width/2,t=i.height/2,a=e-3*d.x,r=t-3*d.y;n.strokeStyle="red",n.lineWidth=2;let o=e-3*s.x,l=t-3*s.y;n.beginPath(),n.moveTo(o-10,l),n.lineTo(o+10,l),n.stroke(),n.beginPath(),n.moveTo(o,l-10),n.lineTo(o,l+10),n.stroke(),n.fillStyle="blue",n.beginPath(),n.arc(a,r,5,0,2*Math.PI),n.fill(),n.fillStyle="black",n.font="16px Arial",n.fillText(`Gaze: (${d.x.toFixed(2)}, ${d.y.toFixed(2)}) , ${h().toFixed(2)}`,a+10,r)}}});