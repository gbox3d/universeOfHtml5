import{FaceLandmarker as e,FilesetResolver as t}from"https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@latest";export default(async(a,i,r=20)=>{let o,n,s={x:0,y:0};i&&(n=i.getContext("2d"));let l={x:0,y:0,z:0},d=await t.forVisionTasks("https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@latest/wasm");o=await e.createFromOptions(d,{baseOptions:{modelAssetPath:"https://storage.googleapis.com/mediapipe-models/face_landmarker/face_landmarker/float16/1/face_landmarker.task",delegate:"GPU"},outputFacialTransformationMatrixes:!0,runningMode:"VIDEO",numFaces:5});let c=null,$=async()=>{let e=await o.detectForVideo(a,performance.now());c=e;try{if(e.faceLandmarks&&e.faceLandmarks.length>0&&e.facialTransformationMatrixes.length>0){let t=e.facialTransformationMatrixes[0],i=t.data,r={x:i[12],y:i[13],z:i[14]},n={x:i[8],y:i[9],z:i[10]};l=f(r,n)}}catch(s){console.error(s)}requestAnimationFrame($)};function f(e,t){let a=(0-e.z)/t.z;return{x:e.x+a*t.x,y:e.y+a*t.y,z:0}}function m(e){return new Promise((t,a)=>{e.readyState>=2?t():(e.addEventListener("loadeddata",()=>t(),{once:!0}),e.addEventListener("error",()=>a("❌ Video failed to load."),{once:!0}))})}let h=()=>Math.sqrt((s.x-l.x)**2+(s.y-l.y)**2),g=()=>{let e=h();return Math.max(0,100*(1-e/r))},y=()=>{let e=c;if(!e.faceLandmarks||0===e.faceLandmarks.length)return{faceok:!1,eyeclose:!1,mouthclose:!0,oneface:!1};let t=e.faceLandmarks.length>0,a=1===e.faceLandmarks.length;if(!a)return{faceok:t,eyeclose:!1,mouthclose:!0,oneface:a};let i=e.faceLandmarks[0],r=i[159],o=i[145],n=i[386],s=i[374],l=i[13],d=i[14],$=(e,t)=>Math.sqrt((e.x-t.x)**2+(e.y-t.y)**2),f=$(r,o),m=$(n,s),h=(f+m)/2,g=$(l,d),y=h<.015,_=g<.04,u={left:f<.015,right:m<.015};return{faceok:t,eyeclose:y,mouthclose:_,oneface:a,eyeclose2:u}};return{async start(e=!1){try{e&&(a.style.display="none");let t=await navigator.mediaDevices.getUserMedia({video:!0});return a.srcObject=t,await m(a),i&&(i.width=a.videoWidth,i.height=a.videoHeight),console.log("\uD83D\uDCCC Webcam successfully loaded."),$(),{success:!0,videoWidth:a.videoWidth,videoHeight:a.videoHeight}}catch(r){return console.error("❌ Error accessing webcam:",r),{success:!1,error:r}}},updateLookAtOrigin(){s.x=l.x,s.y=l.y},getLookAtOrigin:()=>s,getLookAtPoint:()=>l,getGazeDistance:()=>h(),getFocusPercentage:()=>g(),getFaceStatus:()=>y(),drawCanvas(){n.clearRect(0,0,i.width,i.height);let e=i.width/2,t=i.height/2,a=e-3*l.x,r=t-3*l.y;n.strokeStyle="red",n.lineWidth=2;let o=e-3*s.x,d=t-3*s.y;n.beginPath(),n.moveTo(o-10,d),n.lineTo(o+10,d),n.stroke(),n.beginPath(),n.moveTo(o,d-10),n.lineTo(o,d+10),n.stroke(),n.fillStyle="blue",n.beginPath(),n.arc(a,r,5,0,2*Math.PI),n.fill(),n.fillStyle="black",n.font="16px Arial",n.fillText(`Gaze: (${l.x.toFixed(2)}, ${l.y.toFixed(2)}) , ${h().toFixed(2)}`,a+10,r)}}});