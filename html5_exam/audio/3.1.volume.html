<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!--
        BufferLoader
    싸운드 파일 도우미 클래스  -->

    <title> buffered sound </title>
    <script src="buffer-loader.js"></script>
</head>

<body>
<p id ='log'>loading....</p>

<input type="range" min="0" max="100" id="volume-control">
<button id="btn-play" >play</button><button id="btn-stop">stop</button>

<script>
    var context;
    var bufferLoader;
    var bufferList;
    var gainNode;

    try {
        context = new webkitAudioContext();
        document.getElementById('log').innerText = 'this browser support webkitAudioContext ';

        bufferLoader = new BufferLoader(context, [
            './sounds/katusha.mp3'],
                function(_bufferList) {//로딩이 모두 완료 되면...
                    document.getElementById('log').innerText = 'load ok';
                    // Create two sources and play them both together.
                    bufferList = _bufferList;
                }
        );
        bufferLoader.load();

        var source1;
        document.getElementById('btn-play').addEventListener('click',function() {
            if (!context.createGain)
                context.createGain = context.createGainNode;
            source1 = context.createBufferSource();
            source1.buffer = bufferList[0];
            gainNode = context.createGain();
            source1.connect(gainNode);
            gainNode.connect(context.destination);

            //연주 끝나면..
            source1.onended = function(evt) {
                console.log('end play');
            }

            source1.start();
        });

        document.getElementById('btn-stop').addEventListener('click',function() {

            source1.stop(0);

        });

        document.querySelector('#volume-control').addEventListener('input',function(e) {
           //console.log(this.value);

            var fraction = parseInt(this.value) / 100;
            // Let's use an x*x curve (x-squared) since simple linear (x) does not
            // sound as good.
            console.log(fraction);
            gainNode.gain.value = fraction * fraction;

        });



    } catch(e) {
        alert('Web Audio API is not supported in this browser');
    }

    var VolumeSample = {
    };

    // Gain node needs to be mutated by volume control.
    VolumeSample.gainNode = null;

    VolumeSample.play = function() {
        if (!context.createGain)
            context.createGain = context.createGainNode;
        this.gainNode = context.createGain();
        var source = context.createBufferSource();
        source.buffer = BUFFERS.techno;

        // Connect source to a gain node
        source.connect(this.gainNode);
        // Connect gain node to destination
        this.gainNode.connect(context.destination);
        // Start playback in a loop
        source.loop = true;
        if (!source.start)
            source.start = source.noteOn;
        source.start(0);
        this.source = source;
    };

    VolumeSample.changeVolume = function(element) {
        var volume = element.value;
        var fraction = parseInt(element.value) / parseInt(element.max);
        // Let's use an x*x curve (x-squared) since simple linear (x) does not
        // sound as good.
        this.gainNode.gain.value = fraction * fraction;
    };

    VolumeSample.stop = function() {
        if (!this.source.stop)
            this.source.stop = source.noteOff;
        this.source.stop(0);
    };

    VolumeSample.toggle = function() {
        this.playing ? this.stop() : this.play();
        this.playing = !this.playing;
    };



</script>


</body>
</html>
