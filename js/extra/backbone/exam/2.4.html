<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <title>hello-backbonejs</title>

        <script src="../lib/jquery.js"></script>


        <script src="../lib/backbone/json2.js"></script>
        <script src="../lib/backbone/underscore.js"></script>
        <script src="../lib/backbone/backbone.js"></script>
        <script src="../lib/backbone/backbone-localstorage.js"></script>



        <script>
            $(function() {
//모델 정의
                var Item = Backbone.Model.extend({
                    defaults: function() {
                        return {
                            text: '',
                            index: Items.nextOrder()
                        };
                    },
                    initialize: function() {
                        console.log('create model : ' + this.get('index'));
                    }
                });

                //콜랙터 정의
                var List = Backbone.Collection.extend({
                    model: Item,
                    localStorage: new Store("backbone-exam2-1"),
                    nextOrder: function() {
                        if (!this.length)
                            return 1;
                        return this.last().get('index') + 1;

                    }
                });

                var Items = new List;

//뷰정의
                var ItemView = Backbone.View.extend({
                    //... is a list tag.
                    tagName: "li",
                    // Cache the template function for a single item.
                    template: _.template($('#item-template').html()),
                    events: {
                        "click #btn-del": "clear" //삭제 이밴트 처리 
                    },
                    initialize: function() {

                        this.model.bind('destroy', this.remove, this); //삭제했을때 동기화 

                        this.render();
                    },
                    render: function() {
                        this.$el.html(this.template(this.model.toJSON()));
                        return this;
                    },
                    clear: function() {
                        console.log('clear : ' + this.model.get('index'));
                        console.log(Items);
                        this.model.destroy();
                        console.log(Items);
                        //this.remove();
                    }

                });

                var AppView = Backbone.View.extend({
                    el: $('#myapp'),
                    events: {
                        "click #btn-add": "createOne"
                    },
                    initialize: function(param) {

                        Items.bind('add', this.addOne, this);
                        Items.bind('reset', this.addAll, this); //패치를 했을때 이밴트가 발생한다.
                        Items.fetch();
                    },
                    addAll: function() { //모든 리스트 원소 새로 추가하기
                        Items.each(this.addOne);
                    },
                    //뷰에 붙이는 코드 collection 의 add 이밴트와 연결되어 호출되어진다.
                    addOne: function(item) {
                        var view = new ItemView({model: item});
                        console.log(view.render().el);
                        this.$("#list-item").append(view.render().el);
                    },
                    createOne: function(e) {
                        Items.create({text: 'hello'}); //여기서 콜랙터(Items)의 add이밴트가 발생한다.
                        console.log('item create');

                    }

                });

                var myApp = new AppView;

            });

        </script>
    </head>
    <body>

        <div id="myapp">
            <button id='btn-add' >add</button>
            <ul id="list-item" ></ul>

        </div>

        <script type="text/template" id="item-template">
            <a><%=text,index%></a> <button id="btn-del">del</button>
        </script>

    </body>
</html>
